name: Release Android APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  release:
    name: Build and Release APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        working-directory: bypass-app/bypass-apk
        run: flutter pub get

      - name: Build APK
        working-directory: bypass-app/bypass-apk
        run: flutter build apk --release --split-per-abi

      - name: Rename APK files
        working-directory: bypass-app/bypass-apk/build/app/outputs/flutter-apk
        run: |
          mv app-armeabi-v7a-release.apk bypass-1236-armeabi-v7a.apk
          mv app-arm64-v8a-release.apk bypass-1236-arm64-v8a.apk
          mv app-x86_64-release.apk bypass-1236-x86_64.apk

      - name: Create Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸŽ¯ BYPASS-1236 Release
          
          ### âœ… ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸:
          - **ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ñ‹ 1â†’2â†’3** - Ð½ÐµÐ¿Ñ€ÐµÑ€Ñ‹Ð²Ð½Ñ‹Ð¹ Ñ€Ñ‹Ð²Ð¾Ðº Ð½Ð° 6 Ð¼Ð¸Ð½ÑƒÑ‚
          - **ÐŸÐ¾Ð»Ð½Ð°Ñ Ð·Ð²ÑƒÐºÐ¾Ð²Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð°** - Audio Anchors Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ñ„Ð°Ð·Ñ‹
          - **Dead Man's Switch** - Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ð¿Ñ€Ð¾ÐºÑ€Ð°ÑÑ‚Ð¸Ð½Ð°Ñ†Ð¸Ð¸
          - **Ð ÐµÐ¶Ð¸Ð¼ Ð˜ÐÐ•Ð Ð¦Ð˜Ð¯** - Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°Ð¹ ÐºÐ¾Ð³Ð´Ð° Ð²Ð¾ÑˆÐµÐ» Ð² Ð¿Ð¾Ñ‚Ð¾Ðº
          - **ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ** - Ð·Ð²ÑƒÐºÐ¾Ð²Ð¾Ð¹ ÑÐ¸Ð³Ð½Ð°Ð» Ð·Ð° 6 ÑÐµÐºÑƒÐ½Ð´ Ð´Ð¾ ÐºÐ¾Ð½Ñ†Ð° Ñ„Ð°Ð·Ñ‹
          
          ### ðŸ“± ÐšÐ°ÐºÐ¾Ð¹ APK Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ:
          - **arm64-v8a** - Ð´Ð»Ñ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Android ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð² (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ)
          - **armeabi-v7a** - Ð´Ð»Ñ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Android ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²
          - **x86_64** - Ð´Ð»Ñ ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð¾Ð² Ð¸ x86 ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²
          
          ### ðŸŽµ Ð—Ð²ÑƒÐºÐ¾Ð²Ð°Ñ ÐºÐ°Ñ€Ñ‚Ð°:
          - `scan.mp3` - Ð¤Ð°Ð·Ð° 1: THINKING
          - `bolt.mp3` - ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ 1â†’2
          - `siren.mp3` - ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ 2â†’3
          - `rest.mp3` - ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð¾Ñ‚Ð´Ñ‹Ñ…Ð°
          - `ignite.mp3` - ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð¸Ð½ÐµÑ€Ñ†Ð¸Ð¸
          - `beep.mp3` - ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ
          - `finish.mp3` - ÐžÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð·Ñ‹
          
          ### ðŸ“‹ Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ:
          - Flutter SDK: 3.27.1
          - Build Date: $(date)
          - Commit: ${{ github.sha }}
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version || github.ref_name }}
          name: BYPASS-1236 ${{ github.event.inputs.version || github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            bypass-app/bypass-apk/build/app/outputs/flutter-apk/bypass-1236-armeabi-v7a.apk
            bypass-app/bypass-apk/build/app/outputs/flutter-apk/bypass-1236-arm64-v8a.apk
            bypass-app/bypass-apk/build/app/outputs/flutter-apk/bypass-1236-x86_64.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
